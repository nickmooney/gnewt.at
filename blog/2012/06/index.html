<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
<title>  2012  June | Gnewt&#039;s Blag</title>
<meta name="description" content="Arduino, Circular Linked Lists, and Christmas Lights" />
<link rel="alternate" type="application/rss+xml" title="Gnewt&#039;s Blag RSS Feed" href="../../feed/index.html" />
<link rel="alternate" type="application/atom+xml" title="Gnewt&#039;s Blag Atom Feed" href="../../feed/atom/index.html" /> 
<link rel="pingback" href="http://www.gnewt.at/blog/xmlrpc.php" />

<link rel="stylesheet" href="../../wp-content/themes/monochrome/style.css" type="text/css" />
<link rel="stylesheet" href="../../wp-content/themes/monochrome/comment-style.css" type="text/css" />
<!--[if lt IE 7]>
<link rel="stylesheet" href="http://www.gnewt.at/blog/wp-content/themes/monochrome/ie6.css" type="text/css" />
<![endif]--> 
<style type="text/css">
.post img, .post a img { border:1px solid #ccc; padding:5px; margin:0 10px 0 0;  background:#f2f2f2; }
.post a:hover img { border:1px solid #38a1e5; background:#9cd1e1; }
.post img.wp-smiley { border:0px; padding:0px; margin:0px; background:none; }
</style>

 
<link rel='dns-prefetch' href='http://s.w.org/' />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.2.1\/svg\/","svgExt":".svg","source":{"concatemoji":"http:\/\/www.gnewt.at\/blog\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.7.2"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),!(j.toDataURL().length<3e3)&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,65039,8205,55356,57096),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57331,55356,57096),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55357,56425,55356,57341,8205,55357,56507),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55357,56425,55356,57341,55357,56507),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<!-- This site uses the Google Analytics by MonsterInsights plugin v5.5.4 - Universal enabled - https://www.monsterinsights.com/ -->
<script type="text/javascript">
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','__gaTracker');

	__gaTracker('create', 'UA-32955882-1', 'auto');
	__gaTracker('set', 'forceSSL', true);
	__gaTracker('send','pageview');

</script>
<!-- / Google Analytics by MonsterInsights -->
<script type='text/javascript' src='../../wp-includes/js/jquery/jquery.js%3Fver=1.12.4'></script>
<script type='text/javascript' src='../../wp-includes/js/jquery/jquery-migrate.min.js%3Fver=1.4.1'></script>
<link rel='https://api.w.org/' href='../../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../xmlrpc.php%3Frsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="../../wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.7.2" />
<style type="text/css" id="syntaxhighlighteranchor"></style>
<script type="text/javascript" src="../../wp-content/themes/monochrome/js/scroll.js"></script>
<script type="text/javascript" src="../../wp-content/themes/monochrome/js/jscript.js"></script>
<script type="text/javascript" src="../../wp-content/themes/monochrome/js/comment.js"></script>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-15905622-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</head>

<body>
<div id="wrapper">

 <div id="header">

  <div id="header_top">

   <div id="logo">
       <a href="../../../index.html">Gnewt&#039;s Blag</a>
    <h1>She turned me into a Gnewt! I got better&#8230;</h1>
      </div>

      <div class="header_menu">
    <ul class="menu">
     <li class="page_item"><a href="../../../index.html">HOME</a></li>
     <li class="page_item page-item-2"><a href="../../index.html%3Fp=2.html">/usr/bin/whoami</a></li>
    </ul>
   </div>
   
  </div>

  </div><!-- #header end -->  <div id="contents" class="clearfix">

   <div id="left_col">


    <div id="header_meta">

          <p>Archive for <span id="keyword">June, 2012</span></p>

     
    </div><!-- #header_meta end -->


    <div class="post_odd">
     <div class="post clearfix">
      <div class="post_content_wrapper">
       <h2 class="post_title"><a href="../../index.html%3Fp=192.html">Arduino, Circular Linked Lists, and Christmas Lights</a></h2>
       <div class="post_content">
        <p><strong>EDIT: </strong>Yes, the linked list solution is not the most efficient one (and in fact could be dangerous if used with much more memory than this when malloc&#8217;d on a small chip like the Arduino). The &#8220;right&#8221; way is using a circular buffer. A sketch utilizing a circular buffer has been added to the github project.</p>
<p>Around two years ago, a fellow by the name of darco posted an article called &#8220;<a href="http://www.deepdarc.com/2010/11/27/hacking-christmas-lights/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://www.deepdarc.com/2010/11/27/hacking-christmas-lights/', 'Hacking Christmas Lights');">Hacking Christmas Lights</a>&#8221; on his blog. He was nice enough to reverse engineer the LED data bus protocol of the GE Color Effects christmas lights, as well as release some code for an ATMel microcontroller. This was of course turned into an <a href="http://www.digitalmisery.com/2011/11/ge-color-effects-arduino-library/" onclick="__gaTracker('send', 'event', 'outbound-article', 'http://www.digitalmisery.com/2011/11/ge-color-effects-arduino-library/', 'Arduino library');">Arduino library</a> soon after.</p>
<p>I had an idea for something to do with these lights: I wanted a network service I could connect to which would pick a random color from a pre-defined list, tell me which color it picked, and then &#8220;push&#8221; that color onto the string of lights. Each time the service was hit, a new color would enter the string of lights. Each other color would move to the next light until it was at the end of the string, where it would &#8220;fall off.&#8221;</p>
<p>I decided to do all the networking and color choosing in a Python script on my laptop, leaving the Arduino with just the task of controlling the lights and storing their colors. The GEColorEffects library would handle the control, so all I needed to do on that end was find a data structure to store the colors in. Usually I would just use an array, but this approach gets ugly when you want to &#8220;move&#8221; each color to the next light. It would involve copying every single color value in the array to the next location before adding the new color.</p>
<pre class="brush: cpp; title: ; notranslate" title="">// colors are 12 bits, so can be stored in a 16-bit type easily
uint16_t lights[NUMLIGHTS]; // populated somewhere else in code
int i;

--snip--

for (i = NUMLIGHTS; i &gt; 1; i--) {
    lights[i-1] = lights[i-2];
}

lights[0] = newcolor;</pre>
<p>The previous code would have to be called every time I wanted to add a new color to the string of lights. It would probably work just fine (meaning sufficiently fast) considering that it&#8217;s only copying 72 bytes, but it feels clunky. I wanted an approach which felt elegant. The thing that came to mind after some shower-aided thinking (all good programming ideas happen in the shower) was a circular linked list. A linked list is a collection of structures, 0r collections of data, with the unique characteristic that each structure contains a pointer to the next one. In a doubly-linked list, each structure contains a pointer to the previous and the next one. In a circular linked list, the last structure points to the first, effectively making it act like a circle. If you were to follow the path forever, you&#8217;d never reach an end.</p>
<p>The nice part of using circular linked lists is that you can just choose where the &#8220;beginning&#8221; is dynamically.</p>
<pre class="brush: cpp; title: ; notranslate" title="">struct RGB
{
    // each color is only 4 bits but stored as an 8-bit type
    uint8_t r;
    uint8_t g;
    uint8_t b;
    struct RGB *next; // pointer to the next RGB structure
};
typedef struct RGB rgb;

rgb *head;

void populate_linked_list()
{
  int i;
  rgb *curr;
  curr = head = (rgb*)malloc(sizeof(rgb)); // allocate first struct as head

  for (i = 0; i &lt; lightCount-1; i++) { // allocate 35 more (36 lights total)
      curr-&gt;r = 15; // they all start out red
      curr-&gt;g = curr-&gt;b = 0;
      curr-&gt;next = (rgb*)malloc(sizeof(rgb));
      curr = curr-&gt;next;
  }
  // and finally, the last struct
  curr-&gt;r = 15;
  curr-&gt;g = curr-&gt;b = 0;
  curr-&gt;next = head; // the &quot;next&quot; after the last, is the first
  curr = head;
}</pre>
<p>The lights are set by iterating through the list and using the GEColorEffects library to set each light to the color represented by each structure. Here comes the fun part. To &#8220;push&#8221; a color onto the set of lights (and move each other color to the next light), all you have to do is write the color values to the current head of the list, and then move the head to point to the next structure. Keep in mind that we&#8217;re pushing colors onto the end of the list, and each color at the very beginning of the list falls off when we do that.</p>
<pre class="brush: cpp; title: ; notranslate" title="">void add_color(uint8_t r, uint8_t g, uint8_t b)
{
  head-&gt;r = r;
  head-&gt;g = g;
  head-&gt;b = b;
  head = head-&gt;next;
}</pre>
<p>We&#8217;ve just moved the beginning/head of the list one light forward (meaning the 2nd color on the string of lights moves to the 1st, 3rd moves to 2nd etc.) and put the data for the new color in the previous location of the head, which is now the very end of the list. The colors of the lights appear to move accordingly.</p>
<p>I put the code on github <a href="https://github.com/Gnewt/circular-christmas-lights/" onclick="__gaTracker('send', 'event', 'outbound-article', 'https://github.com/Gnewt/circular-christmas-lights/', 'here');">here</a>. It comes with the Arduino sketch which implements the linked list setup as well as a simple serial interface. Read the README for more info about that.</p>
       </div>
      </div>
      <dl class="post_meta">
        <dt class="meta_date">2012</dt>
         <dd class="post_date">06<span>/26</span></dd>
                <dt>CATEGORY</dt>
         <dd><a href="../../category/uncategorized/index.html" rel="category tag">Uncategorized</a></dd>
                                 <dt class="meta_comment"><a href="../../index.html%3Fp=192.html#comments"><span class="dsq-postid" data-dsqidentifier="192 http://www.gnewt.at/blog/?p=192">4 comments</span></a></dt>
               </dl>
     </div>
    </div>


    <div class="content_noside">
     <div class="page_navi clearfix">

</div>
    </div>

   </div><!-- #left_col end -->

   <div id="right_col">
  
    <div id="information_area" class="clearfix">
   <div class="side_box" id="information">
    <h3>Information</h3>
    <div id="information_contents">I'm Gnewt and I make things.</div>
   </div>
      <div id="entries_rss">
    <a href="../../feed/index.html" title="Entries RSS" >RSS FEED</a>
   </div>
     </div>
  
    <div class="side_box" id="search_area_top">
   <div id="search_area" class="clearfix">
        <form method="get" id="searchform" action="../../../index.html">
     <div><input type="text" value="Search" name="s" id="search_input" onfocus="this.value=''; changefc('white');" /></div>
     <div><input type="image" src="../../wp-content/themes/monochrome/img/search_button.gif" alt="Search from this blog." title="Search from this blog." id="search_button" /></div>
    </form>
       </div>
     </div>
  
  
   <div class="side_box">
   <h3>Recent entry</h3>
    <ul>
     <li class="side_date">2014-04-14</li>
     <li><a href="../../index.html%3Fp=291.html">BHS Shirt Sales with Django</a></li>
     <li class="side_date">2014-01-14</li>
     <li><a href="../../index.html%3Fp=276.html">What Would the Bhagavad Gita Say?</a></li>
     <li class="side_date">2013-09-15</li>
     <li><a href="../../index.html%3Fp=250.html">Weekend Project: Web-controlled Christmas Lights with Node.js, Arduino, and Raspberry Pi</a></li>
     <li class="side_date">2013-08-18</li>
     <li><a href="../../index.html%3Fp=244.html">Publishing Data to Redis with Django Signals</a></li>
     <li class="side_date">2012-07-13</li>
     <li><a href="../../index.html%3Fp=235.html">Scripting an Ice Cream Delivery with the Android SDK</a></li>
   </ul>
  </div>

   <div class="side_box">
   <h3>Archive</h3>
   <ul>
    	<li><a href='../../2014/04/index.html'>April 2014</a></li>
	<li><a href='../../2014/01/index.html'>January 2014</a></li>
	<li><a href='../../2013/09/index.html'>September 2013</a></li>
	<li><a href='../../2013/08/index.html'>August 2013</a></li>
	<li><a href='../07/index.html'>July 2012</a></li>
	<li><a href='index.html'>June 2012</a></li>
	<li><a href='../../2011/05/index.html'>May 2011</a></li>
	<li><a href='../../2010/05/index.html'>May 2010</a></li>
	<li><a href='../../2010/04/index.html'>April 2010</a></li>
	<li><a href='../../2009/10/index.html'>October 2009</a></li>
	<li><a href='../../2009/03/index.html'>March 2009</a></li>
   </ul>
   </div>

   <div class="side_box">
   <h3>Category</h3>
   <ul>
    	<li class="cat-item cat-item-23"><a href="../../category/code/index.html" >Code</a>
</li>
	<li class="cat-item cat-item-1"><a href="../../category/uncategorized/index.html" >Uncategorized</a>
</li>
   </ul>
   </div>


  
</div><!-- #right_col end -->
  </div><!-- #contents end -->

  <div id="footer">
   <ul id="copyright">
    <li style="background:none;">
                Copyright &copy;&nbsp; 2009-2017     &nbsp;<a href="../../../index.html">Gnewt&#039;s Blag</a></li>
    <li><a href="http://www.mono-lab.net/">Theme designed by mono-lab</a></li>
    <li><a href="http://wordpress.org/">Powered by WordPress</a></li>
   </ul>
  </div>
 
</div><!-- #wrapper end -->

<div id="return_top">
 <a href="index.html#wrapper">&nbsp;</a>
</div>

<script type='text/javascript' src='../../wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js%3Fver=3.0.9b'></script>
<script type='text/javascript' src='../../wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCpp.js%3Fver=3.0.9b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://www.gnewt.at/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://www.gnewt.at/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();
</script>
<script type='text/javascript' src='../../wp-includes/js/wp-embed.min.js%3Fver=4.7.2'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var countVars = {"disqusShortname":"gnewt"};
/* ]]> */
</script>
<script type='text/javascript' src='../../wp-content/plugins/disqus-comment-system/media/js/count.js%3Fver=4.7.2'></script>
</body>
</html>
<!-- Dynamic page generated in 0.060 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2017-02-01 13:12:34 -->
